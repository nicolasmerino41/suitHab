---
title: "AM Vs BAM BSH"
author: "Nico & Núria"
date: "2025-09-24"
output:
  pdf_document:
    toc: false
    toc_depth: 5
  html_document:
    theme: flatly
    toc: true
    toc_depth: 5
    number_sections: true
    toc_float:
      collapsed: false
    highlight: tango
  word_document:
    toc: false
    toc_depth: '5'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Why AM-BSH and BAM-BSH diverge (before any habitat loss)

**Goal.** Explain the difference between abiotic-only suitability (AM-BSH) and suitability that also requires prey (BAM-BSH). We quantify how that difference changes with (i) metaweb structure and (ii) climatic niche construction, without invoking habitat loss geometry.

---

## What we compare

- **AM-BSH**: a cell is suitable for a consumer if it passes the abiotic gate \(A\) (for example, suitability >= \(\tau_A\)).
- **BAM-BSH**: a cell is suitable only if it passes \(A\) and the consumer finds enough prey there (the \(B\) condition), defined as having at least \(k\) required prey present (or meeting an aggregator threshold).

We summarize the separation with map-level metrics (averages across consumers unless noted):

- **\( \Delta_{Area} \)** = mean area(AM) minus mean area(BAM). Larger values mean stronger biotic restriction.

- **\( \Delta_{Gini} \)** = Gini(AM per-species areas) minus Gini(BAM per-species areas).

- **TailLoss** = change in the high quantile (for example, 90th percentile) of per-species losses.

- **\( \Delta_{Splus} \)** = change in the number of species with any suitable area.

- **JSD** = Jensen–Shannon divergence between per-species area distributions (AM vs BAM).

We report \( \Delta_{Area} \) and \( \Delta_{Gini} \) in the main text; the others are diagnostics.

---

## Why the gap happens (two measurable mediators)

1. **Prey sufficiency among A-eligible cells**  
   \[
   P_{suff} = Pr(\text{at least k prey present} \mid A\text{-kept cell})
   \]  
   Lower \(P_{suff}\) leads to larger AM to BAM drops.

2. **Prey co-retention structure** (within A-eligible cells)  
   - **K-spectrum**: the ECDF of \(K\), the number of a consumer's prey present in an eligible cell.  
   - **Redundancy proxy** \(R_{0.95}\): the 95th percentile of diet breadth across consumers.  
   Lower redundancy and weaker co-retention lead to larger gaps.

Our parameters act by moving these two mediators.

---

## The knobs that tune the gap

### A) Metaweb structure
- **Connectance or density (C)**: lower C means less redundancy and larger \( \Delta \)Area.  
- **Diet breadth (mean and variance, summarized by \(R_{0.95}\))**: narrower diets mean larger \( \Delta \)Area.  
- **Motif mix**: more strict chains and strong modularity give larger \( \Delta \)Area; more omnivory or shared prey give smaller \( \Delta_{Area} \)

### B) Climatic niche construction
- **Consumer–prey climatic alignment (align)**: higher align means prey and consumers co-occur, giving smaller \( \Delta_{Area} \).  
- **Niche breadth (sigma)**: narrower climatic niches give larger \( \Delta_{Area} \).  
- *(Optional)* **Abiotic stringency (tau_A)**: very strict A can compress the gap, while moderate A lets the B-gate dominate.

---

## A compact experiment

We sweep two 2-D slices and replicate each setting:
1. (C, align) at fixed diet redundancy and niche breadth.  
2. (\(R_{0.95}\), sigma) at fixed connectance and alignment.

For each cell of these grids we:

- Build a metaweb with the targeted structure (S species).

- Build abiotic niches with given alignment and breadth.

- Compute AM and BAM maps (no movement, no habitat loss).

- Compute \( \Delta_{Area} \), \( \Delta_{Gini} \), \(P_{suff}\), and K-spectrum summaries.

- Aggregate across replicates to report means and quantile bands.

---

## Expected qualitative patterns

- \( \Delta_{Area} \) decreases monotonically with connectance, diet redundancy, alignment, and niche breadth.
- Low connectance and low alignment combine super-additively to yield the strongest AM to BAM penalties.
- \( \Delta_{Area} \) is well mediated by \(P_{suff}\) and by the K-spectrum; include a simple mediation scatter (\( \Delta_{Area} \) vs \(P_{suff}\)).

This framework separates the biotically-aware correction (BAM) from abiotic-only maps (AM), and explains when and why that correction is large—before any habitat loss geometry is considered.

### What we are measuring and why it changes

We compare two ways to label a cell as 'suitable' for a species:

1) **AM** (abiotic + movement, no biotic screen): a cell is suitable if its climate matches the species' niche (above a threshold \(\tau_A\)).
2) **BAM–BSH** (biotic-aware): the same abiotic test **plus** a prey gate: a consumer must have at least \(k_{req}\) of its potential prey present in the cell.

For each species we measure the fraction of the map it occupies under AM and under BAM, then define  
\[
\Delta \text{Area} = \text{AM}_{area} - \text{BAM}_{area}.
\]  
This is the amount of habitat that looks good abiotically but is removed once we check the food requirement.

Two summary variables are key:

- \(\pi_A\): among consumers, the average fraction of cells that pass the **abiotic** test (so they would be kept by AM).
- \(P_{suff}\): among those A-eligible cells, the probability that the prey requirement is satisfied (there are \(\ge k_{req}\) prey).

A useful approximation is  
\[
\Delta \text{Area} \approx \pi_A \times (1 - P_{suff}).
\]  
It reads as: 'how much abiotic opportunity is there' times 'how often the prey gate fails'.

---

### What the parameters mean

- \(R_{95}\): an index of diet redundancy – roughly how many prey a consumer has within 95% of its diet mass. Larger \(R_{95}\) = more potential prey types.
- \(\sigma\): niche breadth in climate space. Larger \(\sigma\) = broader abiotic tolerance.
- *align*: how correlated species' climate optima are across the web. \(\text{align}=0\) means no correlation; \(\text{align}=1\) means predators and prey prefer very similar climates.
- \(\tau_A\): the abiotic suitability threshold used by AM and by the first step of BAM.
- *motif_mix*: which food-web motifs are emphasized when the synthetic metaweb is generated (e.g. more chains vs more omnivory).
- \(P_{suff}\) (prey sufficiency): the empirical quantity  
  \[
  P(\ge k_{req} \; \text{prey present} \mid A\text{-eligible cell}).
  \]  
  It is the hinge variable for how much biotic gating removes from AM.

---

### Why \(\Delta \text{Area}\) peaks at mid alignment

Alignment pushes two levers in opposite directions. As alignment increases, \(\pi_A\) tends to rise (more abiotic opportunity shared across species), but \(P_{suff}\) also rises (prey co-occur with consumers more often).  
- At very low alignment: small \(\pi_A\) and small \(P_{suff}\).  
- At very high alignment: large \(\pi_A\) and large \(P_{suff}\).  
The product \(\pi_A \times (1 - P_{suff})\) is largest in between. That is why \(\Delta \text{Area}\) is maximal around mid alignment in our heat map.

---

### Why \(\Delta \text{Area}\) sometimes increases with \(R_{95}\) in the \(R_{95}\)–\(\sigma\) heat map

Within consumers, increasing \(R_{95}\) raises redundancy and should make the prey gate easier to pass (\(P_{suff}\) ↑), so \(\Delta \text{Area}\) per consumer should go down.  
However, as \(R_{95}\) grows our synthetic metawebs also shift in trophic composition: a larger share of species are consumers (basal species contribute ~0 to \(\Delta \text{Area}\)). When we average \(\Delta \text{Area}\) over all species, that composition effect can dominate and the mean can rise with \(R_{95}\) even if the consumer-only \(\Delta \text{Area}\) shrinks.

The fix is to report both:  
(i) \(\Delta \text{Area}\) among consumers only (the pure biotic-gate effect),  
(ii) the fraction of consumers (composition),  
and to make clear which average is being shown.

---

### How to read the (\(\delta, \kappa\)) heat map

We also re-parametrize the axes into scale-free quantities:  
- \(\delta = \sigma / L\): niche breadth relative to the grid's climate span.  
- \(\kappa = k_{req} / R_{95}\): the prey requirement measured against redundancy.

At fixed \(\delta\), \(\Delta \text{Area}\) decreases as \(\kappa \to 0\) (the gate is easy) and increases as \(\kappa \to 1\) (the gate is demanding relative to redundancy).  
At fixed \(\kappa\), \(\Delta \text{Area}\) increases with \(\delta\) because AM offers more abiotic opportunity (\(\pi_A\) ↑).  
This parameterization reveals the clean trade-off behind AM vs BAM differences.

---

### Take-home

- \(\Delta \text{Area}\) is governed by \(\pi_A\) (abiotic admission) and \(P_{suff}\) (prey sufficiency).  
- Mid alignment maximizes \(\Delta \text{Area}\) because it maximizes \(\pi_A\) while \(P_{suff}\) is not yet high.  
- Apparent increases of \(\Delta \text{Area}\) with \(R_{95}\) in all-species averages are often composition effects; consumer-only summaries resolve the paradox.  
- Using \(\delta\) and \(\kappa\) gives a scaleless view and produces smooth heat maps you can compare across grid sizes and species richness.


